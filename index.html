<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ—á–∞—Ç</title>
    <style>
        body {
            margin: 0;
            background: black;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
        #loginForm {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 300px;
        }

        #loginForm.hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            border-color: #4CAF50;
            outline: none;
        }

        button {
            padding: 15px 25px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        /* –í–∏–¥–µ–æ –≤—ã–∑—ã–≤–∞–µ–º–æ–≥–æ ‚Äî –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        #remoteVideo {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* –í–∏–¥–µ–æ –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ ‚Äî –º–∞–ª–µ–Ω—å–∫–æ–µ –æ–∫–Ω–æ (PiP) */
        #localVideo {
            width: 150px;
            height: 100px;
            position: absolute;
            bottom: 10px;
            right: 10px;
            border-radius: 10px;
            border: 2px solid white;
            box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.5);
            background: #333;
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .control-btn {
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover {
            background: rgba(200, 200, 200, 0.9);
        }
        
        #status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 100;
        }
        
        .hidden {
            display: none !important;
        }

        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ */
        #roomInfo {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
        }

        #copyRoomBtn {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 10px;
            background: #2196F3;
        }

        #copyRoomBtn:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>

    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div id="loginForm">
        <h2 style="text-align: center; margin-bottom: 20px; color: #333;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–µ–æ—á–∞—Ç–∞</h2>
        
        <div class="form-group">
            <label for="channelId">ScaleDrone Channel ID:</label>
            <input type="text" id="channelId" placeholder="–í–≤–µ–¥–∏—Ç–µ Channel ID" value="HbdbzAINeNp3Eh8f">
        </div>
        
        <div class="form-group">
            <label for="roomName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</label>
            <input type="text" id="roomName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="video-chat-room">
        </div>
        
        <button onclick="initializeChat()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        
        <div style="margin-top: 15px; font-size: 12px; color: #666;">
            <p><strong>–ì–¥–µ –≤–∑—è—Ç—å Channel ID?</strong></p>
            <p>1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ <a href="https://scaledrone.com" target="_blank">scaledrone.com</a></p>
            <p>2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª</p>
            <p>3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ Channel ID –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–Ω–∞–ª–∞</p>
        </div>
    </div>

    <!-- –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∏ -->
    <video id="remoteVideo" autoplay playsinline class="hidden"></video>
    <video id="localVideo" autoplay muted playsinline class="hidden"></video>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ -->
    <div id="roomInfo" class="hidden">
        <div>–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoomName"></span></div>
        <button id="copyRoomBtn" onclick="copyRoomName()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="status" class="hidden">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="controls" class="hidden">
        <button class="control-btn" id="startButton" onclick="startCall()">üìû</button>
        <button class="control-btn" id="endButton" onclick="endCall()">‚ùå</button>
    </div>

    <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
    <script>
        let drone;
        let room;
        let localStream;
        let peerConnection;
        let isCaller = false;
        let currentChannelId = '';
        let currentRoomName = '';

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WebRTC
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const loginForm = document.getElementById('loginForm');
        const statusElement = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const endButton = document.getElementById('endButton');
        const remoteVideo = document.getElementById('remoteVideo');
        const localVideo = document.getElementById('localVideo');
        const roomInfo = document.getElementById('roomInfo');
        const currentRoomNameSpan = document.getElementById('currentRoomName');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        async function initializeChat() {
            const channelId = document.getElementById('channelId').value.trim();
            const roomName = document.getElementById('roomName').value.trim();

            if (!channelId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ScaleDrone Channel ID');
                return;
            }

            if (!roomName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }

            currentChannelId = channelId;
            currentRoomName = roomName;

            try {
                statusElement.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
                statusElement.classList.remove('hidden');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                localVideo.srcObject = localStream;
                localVideo.classList.remove('hidden');
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–∞—Ç–∞
                loginForm.classList.add('hidden');
                remoteVideo.classList.remove('hidden');
                controls.classList.remove('hidden');
                roomInfo.classList.remove('hidden');
                
                currentRoomNameSpan.textContent = currentRoomName;
                statusElement.textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é. –ù–∞–∂–º–∏—Ç–µ üìû —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                statusElement.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
        }

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
        function copyRoomName() {
            navigator.clipboard.writeText(currentRoomName).then(() => {
                const btn = document.getElementById('copyRoomBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
            });
        }

        async function startCall() {
            try {
                statusElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ScaleDrone
                drone = new ScaleDrone(currentChannelId);
                
                drone.on('open', error => {
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ScaleDrone:', error);
                        statusElement.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ScaleDrone. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Channel ID.');
                        return;
                    }
                    
                    statusElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ: ' + currentRoomName;
                    
                    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–æ–º–Ω–∞—Ç—É
                    room = drone.subscribe(currentRoomName);
                    
                    room.on('open', error => {
                        if (error) {
                            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É:', error);
                            statusElement.textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É';
                        }
                    });
                    
                    room.on('members', members => {
                        console.log('–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç—ã:', members);
                        
                        // –ï—Å–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ –±–æ–ª—å—à–µ 2 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–∞—Å)
                        if (members.length > 2) {
                            statusElement.textContent = '–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞ (–º–∞–∫—Å–∏–º—É–º 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞)';
                            return;
                        }
                        
                        // –ï—Å–ª–∏ –º—ã –≤—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫
                        if (members.length === 2) {
                            isCaller = false;
                            startWebRTC();
                        } else {
                            isCaller = true;
                            statusElement.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –∫–æ–º–Ω–∞—Ç–µ: ' + currentRoomName;
                        }
                    });
                    
                    room.on('member_join', member => {
                        console.log('–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫:', member);
                        if (drone.clientId && member.id !== drone.clientId) {
                            isCaller = true;
                            startWebRTC();
                        }
                    });
                    
                    room.on('data', (message, client) => {
                        if (client.id !== drone.clientId) {
                            handleSignalingData(message);
                        }
                    });
                });
                
                drone.on('error', error => {
                    console.error('ScaleDrone error:', error);
                    statusElement.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                startButton.classList.add('hidden');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞:', error);
                statusElement.textContent = '–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞';
            }
        }

        function startWebRTC() {
            statusElement.textContent = isCaller ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...' : '–ü—Ä–∏–µ–º –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞...';
            
            // –°–æ–∑–¥–∞–µ–º PeerConnection
            peerConnection = new RTCPeerConnection(config);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π WebRTC
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    drone.publish({
                        room: currentRoomName,
                        message: { candidate: event.candidate }
                    });
                }
            };
            
            peerConnection.ontrack = event => {
                console.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                remoteVideo.srcObject = event.streams[0];
                statusElement.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            };
            
            peerConnection.onconnectionstatechange = () => {
                console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'connected') {
                    statusElement.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                } else if (peerConnection.connectionState === 'disconnected') {
                    statusElement.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–µ—Ä–≤–∞–Ω–æ';
                }
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –ï—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä, —Å–æ–∑–¥–∞–µ–º offer
            if (isCaller) {
                createOffer();
            }
        }

        async function createOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                drone.publish({
                    room: currentRoomName,
                    message: { offer: peerConnection.localDescription }
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', error);
                statusElement.textContent = '–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            }
        }

        async function handleSignalingData(data) {
            try {
                if (data.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    drone.publish({
                        room: currentRoomName,
                        message: { answer: peerConnection.localDescription }
                    });
                    
                } else if (data.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    
                } else if (data.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ signaling data:', error);
            }
        }

        function endCall() {
            statusElement.textContent = '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç –∫–æ–º–Ω–∞—Ç—ã
            if (room) {
                room.unsubscribe();
                room = null;
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç ScaleDrone
            if (drone) {
                drone.close();
                drone = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
            remoteVideo.srcObject = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            startButton.classList.remove('hidden');
            statusElement.textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é. –ù–∞–∂–º–∏—Ç–µ üìû —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', endCall);

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
        document.getElementById('roomName').value = 'video-chat-' + Math.random().toString(36).substring(2, 8);
    </script>
</body>
</html>