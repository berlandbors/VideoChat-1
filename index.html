<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–¥–µ–æ—á–∞—Ç</title>
    <style>
        body {
            margin: 0;
            background: black;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* –í–∏–¥–µ–æ –≤—ã–∑—ã–≤–∞–µ–º–æ–≥–æ ‚Äî –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        #remoteVideo {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* –í–∏–¥–µ–æ –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ ‚Äî –º–∞–ª–µ–Ω—å–∫–æ–µ –æ–∫–Ω–æ (PiP) */
        #localVideo {
            width: 150px;
            height: 100px;
            position: absolute;
            bottom: 10px;
            right: 10px;
            border-radius: 10px;
            border: 2px solid white;
            box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.5);
            background: #333;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        button {
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background: rgba(200, 200, 200, 0.9);
        }
        
        #status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 100;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <!-- –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∏ -->
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>

    <!-- –°—Ç–∞—Ç—É—Å -->
    <div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="controls">
        <button id="startButton" onclick="startCall()">üìû</button>
        <button id="endButton" onclick="endCall()" class="hidden">‚ùå</button>
    </div>

    <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
    <script>
        const CHANNEL_ID = 'video-chat-' + Math.random().toString(36).substring(2, 10);
        let drone;
        let room;
        let localStream;
        let peerConnection;
        let isCaller = false;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WebRTC
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const statusElement = document.getElementById('status');
        const startButton = document.getElementById('startButton');
        const endButton = document.getElementById('endButton');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', initialize);

        async function initialize() {
            try {
                statusElement.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                statusElement.textContent = '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º:', error);
                statusElement.textContent = '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
            }
        }

        async function startCall() {
            try {
                statusElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ScaleDrone
                drone = new ScaleDrone('HbdbzAINeNp3Eh8f');
                
                drone.on('open', error => {
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ScaleDrone:', error);
                        statusElement.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                        return;
                    }
                    
                    statusElement.textContent = '–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...';
                    
                    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∫–æ–º–Ω–∞—Ç—É
                    room = drone.subscribe(CHANNEL_ID);
                    
                    room.on('open', error => {
                        if (error) {
                            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É:', error);
                            statusElement.textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É';
                        }
                    });
                    
                    room.on('members', members => {
                        console.log('–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç—ã:', members);
                        
                        // –ï—Å–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ –±–æ–ª—å—à–µ 2 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–∞—Å)
                        if (members.length > 2) {
                            statusElement.textContent = '–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞';
                            return;
                        }
                        
                        // –ï—Å–ª–∏ –º—ã –≤—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫
                        if (members.length === 2) {
                            isCaller = false;
                            startWebRTC();
                        } else {
                            isCaller = true;
                        }
                    });
                    
                    room.on('member_join', member => {
                        console.log('–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫:', member);
                        if (drone.clientId && member.id !== drone.clientId) {
                            isCaller = true;
                            startWebRTC();
                        }
                    });
                    
                    room.on('data', (message, client) => {
                        if (client.id !== drone.clientId) {
                            handleSignalingData(message);
                        }
                    });
                });
                
                drone.on('error', error => {
                    console.error('ScaleDrone error:', error);
                    statusElement.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                startButton.classList.add('hidden');
                endButton.classList.remove('hidden');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞:', error);
                statusElement.textContent = '–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–≤–æ–Ω–∫–∞';
            }
        }

        function startWebRTC() {
            statusElement.textContent = isCaller ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...' : '–ü—Ä–∏–µ–º –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞...';
            
            // –°–æ–∑–¥–∞–µ–º PeerConnection
            peerConnection = new RTCPeerConnection(config);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π WebRTC
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    drone.publish({
                        room: CHANNEL_ID,
                        message: { candidate: event.candidate }
                    });
                }
            };
            
            peerConnection.ontrack = event => {
                console.log('–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫');
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                statusElement.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            };
            
            peerConnection.onconnectionstatechange = () => {
                console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'connected') {
                    statusElement.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                }
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // –ï—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä, —Å–æ–∑–¥–∞–µ–º offer
            if (isCaller) {
                createOffer();
            }
        }

        async function createOffer() {
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                drone.publish({
                    room: CHANNEL_ID,
                    message: { offer: peerConnection.localDescription }
                });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', error);
                statusElement.textContent = '–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            }
        }

        async function handleSignalingData(data) {
            try {
                if (data.offer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    drone.publish({
                        room: CHANNEL_ID,
                        message: { answer: peerConnection.localDescription }
                    });
                    
                } else if (data.answer) {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    
                } else if (data.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ signaling data:', error);
            }
        }

        function endCall() {
            statusElement.textContent = '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç –∫–æ–º–Ω–∞—Ç—ã
            if (room) {
                room.unsubscribe();
                room = null;
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç ScaleDrone
            if (drone) {
                drone.close();
                drone = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã
            document.getElementById('remoteVideo').srcObject = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            startButton.classList.remove('hidden');
            endButton.classList.add('hidden');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', endCall);
    </script>
</body>
</html>