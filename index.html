<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–í–∏–¥–µ–æ—á–∞—Ç WebRTC + ScaleDrone</title>

  <style>
    :root{
      --radius: 12px;

      /* –ø–ª–∞–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
      --btn: clamp(44px, 6.2vw, 56px);
      --btn-fz: clamp(16px, 2.4vw, 18px);
      --badge-fz: clamp(12px, 2.2vw, 14px);

      /* PiP */
      --pip-w: clamp(24vw, 32vw, 220px);
      --pip-aspect: 16/11;

      /* –≤—ã—Å–æ—Ç–∞ –±–µ–π–¥–∂–∞ —Å—Ç–∞—Ç—É—Å–∞ (–∑–∞–ø–æ–ª–Ω–∏–º –∏–∑ JS) */
      --status-h: 44px;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }
    body{
      margin: 0;
      background:#000;
      color:#fff;
      font-family: Arial, sans-serif;
      overflow: hidden;

      /* safe-area (—á—ë–ª–∫–∏/–∂–µ—Å—Ç–æ–≤–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è) */
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }

    .hidden{ display:none !important; }

    /* ===== –§–û–†–ú–ê –í–•–û–î–ê ===== */
    #loginForm{
      position: fixed; inset:0;
      display:grid; place-items:center;
      z-index:1000;
      background: rgba(0,0,0,.25);
      padding:16px;
    }
    #loginForm > .card, #loginForm{
      background: rgba(255,255,255,.95);
      color:#111;
      padding:25px;
      border-radius: var(--radius);
      box-shadow: 0 0 15px rgba(0,0,0,.3);
      min-width: min(92vw, 320px);
      max-width: min(92vw, 520px);
    }
    .form-group{ margin-bottom:14px; }
    label{ display:block; font-weight:700; margin-bottom:6px; color:#333; }
    input[type="text"]{
      width:100%; padding:10px 12px;
      border:2px solid #ddd; border-radius:10px;
      font-size: clamp(14px, 2.6vw, 16px);
      outline:none;
    }
    button{
      width:100%; padding:12px;
      font-size: clamp(14px, 2.6vw, 15px);
      border:none; border-radius:10px; font-weight:700;
      background:#4CAF50; color:#fff; cursor:pointer;
    }
    button:hover{ background:#45a049; }

    /* ===== –í–ò–î–ï–û ===== */
    #remoteVideo{
      position: fixed; inset:0;
      width:100vw; height:100vh;
      object-fit: cover;
      background:#000;
      z-index:0;
    }

    /* PiP ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö, —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏, –Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞–µ—Ç—Å—è */
    #localVideo{
      position: fixed;
      right: calc(10px + env(safe-area-inset-right));
      bottom: calc(14px + env(safe-area-inset-bottom));
      left: auto; top: auto; /* –Ω–∞ —Å–ª—É—á–∞–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ left/top */
      width: var(--pip-w);
      height: calc(var(--pip-w) / var(--pip-aspect));
      min-width: 120px;
      min-height: 80px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #fff;
      box-shadow: 0 0 8px rgba(255,255,255,.5), 0 8px 24px rgba(0,0,0,.4);
      background:#333;
      z-index:60;
      cursor: move; /* –ø–æ–¥—Å–∫–∞–∑–∫–∞ —á—Ç–æ –º–æ–∂–Ω–æ —Ç–∞—Å–∫–∞—Ç—å */
    }

    /* ===== –°–¢–ê–¢–£–° (–≤–µ—Ä—Ö-—Ü–µ–Ω—Ç—Ä) ===== */
    #status{
      position: fixed;
      top: calc(12px + env(safe-area-inset-top));
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.6);
      color:#fff;
      padding: 6px 14px;
      border-radius: 999px;
      display:flex; align-items:center; gap:8px;
      z-index:90;
      font-size: var(--badge-fz);
      white-space: nowrap;
      max-width: 86vw;
      overflow: hidden; text-overflow: ellipsis;
    }
    #statusDot{ width:10px; height:10px; border-radius:50%; background:gray; }

    /* ===== –ü–ê–ù–ï–õ–¨ (–Ω–∏–∑-—Ü–µ–Ω—Ç—Ä) ===== */
    #controls{
      position: fixed;
      left: 50%; transform: translateX(-50%);
      bottom: calc(16px + env(safe-area-inset-bottom));
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 1fr;
      gap: 10px;
      background: rgba(0,0,0,.45);
      padding: 8px 10px;
      border-radius: 999px;
      backdrop-filter: blur(4px);
      z-index:55;
    }
    .control-btn{
      width: var(--btn);
      height: var(--btn);
      border-radius: 50%;
      border: none;
      font-size: var(--btn-fz);
      cursor: pointer;
      background: rgba(255,255,255,.92);
      color:#111;
      display:grid; place-items:center;
    }
    .control-btn:active{ transform: translateY(1px); }
    .danger{ background:#e74c3c; color:#fff; }
    .toggled{ background:#f39c12; color:#fff; }

    /* ===== –ë–õ–û–ö –ö–û–ú–ù–ê–¢–´ (–≤–µ—Ä—Ö-–ø—Ä–∞–≤–æ) ===== */
    #roomInfo{
      position: fixed;
      /* –æ–ø—É—Å–∫–∞–µ–º –Ω–∏–∂–µ –±–µ–π–¥–∂–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É (var(--status-h)) */
      top: calc(12px + env(safe-area-inset-top) + var(--status-h) + 8px);
      right: calc(12px + env(safe-area-inset-right));
      background: rgba(0,0,0,.6);
      color:#fff;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: var(--badge-fz);
      z-index:80;
      display:grid; gap:6px; justify-items: end;
      max-width: 60vw;
    }
    #copyRoomBtn, #shareRoomBtn{
      font-size: clamp(12px, 2.2vw, 13px);
      background:#2196F3; color:#fff;
      padding: 4px 8px; border:none; border-radius:8px;
      cursor:pointer;
    }
    #copyRoomBtn:hover, #shareRoomBtn:hover{ background:#1976D2; }

    /* ===== –ë–†–ï–ô–ö–ü–û–ò–ù–¢–´ ===== */

    /* –£–∑–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
    @media (max-width: 420px){
      #roomInfo{
        padding: 6px 8px;
        justify-items: stretch;
        max-width: 76vw;
      }
      #roomInfo button{
        display:block; width:100%;
        font-size: 11px; padding: 4px 6px; margin-top: 4px;
      }

      /* –ü–∞–Ω–µ–ª—å 2√ó2 */
      #controls{
        grid-auto-flow: row;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        padding: 6px;
        border-radius: 16px;
        bottom: calc(10px + env(safe-area-inset-bottom));
      }
      .control-btn{ width: 44px; height: 44px; font-size: 16px; }

      /* PiP –≤—ã—à–µ –ø–∞–Ω–µ–ª–∏ */
      #localVideo{
        width: 140px; height: 96px;
        bottom: calc(90px + env(safe-area-inset-bottom));
        right: calc(8px + env(safe-area-inset-right));
      }
    }

    /* –°—Ä–µ–¥–Ω–∏–µ (–ø–ª–∞–Ω—à–µ—Ç—ã –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–µ) */
    @media (min-width: 480px) and (max-width: 768px){
      :root{ --pip-w: clamp(26vw, 30vw, 240px); }
    }

    /* –î–µ—Å–∫—Ç–æ–ø—ã */
    @media (min-width: 768px){
      :root{ --pip-w: clamp(18vw, 22vw, 260px); }
      #controls{ gap: 12px; }
    }

    /* –ù–∏–∑–∫–∞—è –≤—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞ (–ª–∞–Ω–¥—à–∞—Ñ—Ç) */
    @media (max-height: 520px){
      :root{ --btn: clamp(40px, 7vh, 48px); }
      #status{ top: calc(8px + env(safe-area-inset-top)); }
      #roomInfo{ top: calc(8px + env(safe-area-inset-top) + var(--status-h) + 6px); }
      #controls{ bottom: calc(8px + env(safe-area-inset-bottom)); padding:6px 8px; }
      #localVideo{
        bottom: calc(8px + env(safe-area-inset-bottom));
        right: calc(8px + env(safe-area-inset-right));
      }
    }

    /* –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ —É–∑–∫–∏–µ/–Ω–∏–∑–∫–∏–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë —Ü–µ–ª–∏–∫–æ–º */
    @media (max-width: 340px), (max-height: 420px){
      #remoteVideo{ object-fit: contain; }
    }
  </style>
</head>

<body>
  <!-- –§–æ—Ä–º–∞ -->
  <div id="loginForm">
    <h3 style="text-align:center; margin-top:0;">–í—Ö–æ–¥ –≤ –≤–∏–¥–µ–æ—á–∞—Ç</h3>
    <div class="form-group">
      <label for="channelId">ScaleDrone Channel ID:</label>
      <input type="text" id="channelId" placeholder="–í–≤–µ–¥–∏—Ç–µ Channel ID">
    </div>
    <div class="form-group">
      <label for="roomName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</label>
      <input type="text" id="roomName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
    </div>
    <button onclick="initializeChat()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <!-- –í–∏–¥–µ–æ -->
  <video id="remoteVideo" autoplay playsinline class="hidden"></video>
  <video id="localVideo" autoplay muted playsinline class="hidden"></video>

  <!-- –°—Ç–∞—Ç—É—Å -->
  <div id="status" class="hidden">
    <div id="statusDot"></div>
    <div id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å -->
  <div id="controls" class="hidden">
    <button class="control-btn" id="startButton" onclick="startCall()">üìû</button>
    <button class="control-btn danger" onclick="endCall()">‚ùå</button>
    <button class="control-btn" id="micButton" onclick="toggleMic()">üé§</button>
    <button class="control-btn" id="camButton" onclick="toggleCam()">üì∑</button>
  </div>

  <!-- –ò–Ω—Ñ–æ –æ –∫–æ–º–Ω–∞—Ç–µ -->
  <div id="roomInfo" class="hidden">
    <div>–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoomName"></span></div>
    <button id="copyRoomBtn" onclick="copyRoomName()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="shareRoomBtn" onclick="shareRoom()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
  </div>

  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
  <script>
    let drone, room, pc, localStream;
    let currentChannelId = '', currentRoomName = '';

    const statusEl   = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const statusDot  = document.getElementById('statusDot');
    const loginForm  = document.getElementById('loginForm');
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo  = document.getElementById('localVideo');
    const controls    = document.getElementById('controls');
    const roomInfo    = document.getElementById('roomInfo');
    const currentRoomNameSpan = document.getElementById('currentRoomName');

    const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // --- —É—Ç–∏–ª–∏—Ç—ã UI ---
    function setStatus(text, color){
      statusText.textContent = text;
      statusDot.style.background = color || 'gray';
      // –ü—Ä–æ–∫–∏–Ω–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –±–µ–π–¥–∂–∞ –≤ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (–¥–ª—è –æ—Ç—Å—Ç—É–ø–∞ –±–ª–æ–∫–∞ –ö–æ–º–Ω–∞—Ç—ã)
      requestAnimationFrame(() => {
        const h = statusEl.offsetHeight || 44;
        document.documentElement.style.setProperty('--status-h', h + 'px');
      });
    }

    function ensurePiPSize(){
      const w = localVideo.videoWidth || 0;
      const h = localVideo.videoHeight || 0;
      if (w < 2 || h < 2){
        // –¥–µ—Ñ–æ–ª—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –µ—â—ë –Ω–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–ª —Ä–∞–∑–º–µ—Ä
        localVideo.style.width = '160px';
        localVideo.style.height = '110px';
      }
    }

    // --- –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ PiP ---
    function makeDraggable(el){
      let sx=0, sy=0, ex=0, ey=0, dragging=false;
      const clamp = (v,min,max)=>Math.min(Math.max(v,min), max);

      function onDown(e){
        dragging = true;
        const p = e.touches ? e.touches[0] : e;
        sx = p.clientX; sy = p.clientY;
        const r = el.getBoundingClientRect();
        ex = r.left; ey = r.top;
        el.style.transition = 'none';
        e.preventDefault();
      }
      function onMove(e){
        if (!dragging) return;
        const p = e.touches ? e.touches[0] : e;
        const dx = p.clientX - sx;
        const dy = p.clientY - sy;
        const vw = window.innerWidth, vh = window.innerHeight;
        const r = el.getBoundingClientRect();
        const nx = clamp(ex + dx, 4, vw - r.width - 4);
        const ny = clamp(ey + dy, 4, vh - r.height - 4);
        el.style.left = nx + 'px';
        el.style.top  = ny + 'px';
        el.style.right = 'auto';
        el.style.bottom = 'auto';
      }
      function onUp(){ dragging=false; el.style.transition=''; }

      el.addEventListener('mousedown', onDown);
      el.addEventListener('touchstart', onDown, {passive:false});
      window.addEventListener('mousemove', onMove, {passive:false});
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp);
      window.addEventListener('touchend', onUp);
    }

    // --- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    async function initializeChat(){
      currentChannelId = document.getElementById('channelId').value.trim();
      currentRoomName = document.getElementById('roomName').value.trim();
      if (!currentChannelId || !currentRoomName) return alert('–í–≤–µ–¥–∏—Ç–µ Channel ID –∏ –∫–æ–º–Ω–∞—Ç—É');

      statusEl.classList.remove('hidden');
      controls.classList.remove('hidden');
      roomInfo.classList.remove('hidden');
      remoteVideo.classList.remove('hidden');

      currentRoomNameSpan.textContent = currentRoomName;
      setStatus('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'gray');

      try{
        localVideo.muted = true;
        localVideo.playsInline = true;

        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        localVideo.srcObject = localStream;

        localVideo.onloadedmetadata = () => {
          localVideo.play().catch(()=>{});
          ensurePiPSize();
          localVideo.classList.remove('hidden');
          makeDraggable(localVideo);
        };

        loginForm.classList.add('hidden');
        setStatus('–ù–∞–∂–º–∏—Ç–µ üìû —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫', 'gray');
      }catch(err){
        console.error(err);
        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
        setStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º', 'red');
      }
    }

    // --- –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è ---
    function copyRoomName(){
      navigator.clipboard.writeText(currentRoomName).then(()=>{
        const btn = document.getElementById('copyRoomBtn');
        const t = btn.textContent;
        btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
        setTimeout(()=> btn.textContent = t, 2000);
      });
    }
    function shareRoom(){
      const shareUrl = `${location.origin}${location.pathname}?room=${encodeURIComponent(currentRoomName)}`;
      navigator.clipboard.writeText(shareUrl).then(()=>{
        const btn = document.getElementById('shareRoomBtn');
        const t = btn.textContent;
        btn.textContent = '‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞';
        setTimeout(()=> btn.textContent = t, 2000);
      });
    }

    // --- ScaleDrone + WebRTC (–æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ä–∞–±–æ—á–µ–º –ø—Ä–∏–º–µ—Ä–µ GitHub) ---
    function startCall(){
      setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'orange');

      drone = new ScaleDrone(currentChannelId);
      const roomKey = 'observable-' + currentRoomName;

      drone.on('open', error => {
        if (error) { console.error(error); setStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ScaleDrone', 'red'); return; }

        room = drone.subscribe(roomKey);

        // –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—Ç–æ Offerer
        room.on('members', members => {
          const isOfferer = members.length === 2;
          startWebRTC(isOfferer, roomKey);
        });

        room.on('open', e => { if (e) console.error(e); });
      });
    }

    function sendMessage(roomKey, message){
      if (!drone) return;
      drone.publish({ room: roomKey, message });
    }

    function startWebRTC(isOfferer, roomKey){
      pc = new RTCPeerConnection(config);

      // –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã ‚Üí —á–µ—Ä–µ–∑ ScaleDrone
      pc.onicecandidate = e => {
        if (e.candidate) sendMessage(roomKey, { candidate: e.candidate });
      };

      // –ü—Ä–∏—à—ë–ª —É–¥–∞–ª—ë–Ω–Ω—ã–π —Ç—Ä–µ–∫
      pc.ontrack = e => {
        const stream = e.streams[0];
        if (!remoteVideo.srcObject || remoteVideo.srcObject.id !== stream.id) {
          remoteVideo.srcObject = stream;
          setStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'green');
        }
      };

      // Offerer —Å–æ–∑–¥–∞—ë—Ç –æ—Ñ—Ñ–µ—Ä –Ω–∞ negotiationneeded
      if (isOfferer) {
        pc.onnegotiationneeded = () => {
          pc.createOffer().then(localDescCreated).catch(console.error);
        };
      }

      // –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      room.on('data', (message, client) => {
        if (client.id === drone.clientId) return; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

        if (message.sdp) {
          pc.setRemoteDescription(new RTCSessionDescription(message.sdp), () => {
            if (pc.remoteDescription.type === 'offer') {
              pc.createAnswer().then(localDescCreated).catch(console.error);
            }
          }, console.error);
        } else if (message.candidate) {
          pc.addIceCandidate(new RTCIceCandidate(message.candidate)).catch(console.error);
        }
      });

      function localDescCreated(desc){
        pc.setLocalDescription(desc, () => {
          sendMessage(roomKey, { sdp: pc.localDescription });
        }, console.error);
      }
    }

    // --- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ, mute/cam ---
    function endCall(){
      if (pc) { pc.close(); pc = null; }
      if (drone) { drone.close(); drone = null; }
      remoteVideo.srcObject = null;
      setStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω', 'red');
    }

    function toggleMic(){
      const t = localStream?.getAudioTracks?.()[0];
      if (!t) return;
      t.enabled = !t.enabled;
      document.getElementById('micButton').classList.toggle('toggled', !t.enabled);
    }

    function toggleCam(){
      const t = localStream?.getVideoTracks?.()[0];
      if (!t) return;
      t.enabled = !t.enabled;
      document.getElementById('camButton').classList.toggle('toggled', !t.enabled);
    }

    window.addEventListener('beforeunload', endCall);

    // --- –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ ?room= ---
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const roomParam = urlParams.get('room');
      if (roomParam) document.getElementById('roomName').value = roomParam;
    });
  </script>
</body>
</html>