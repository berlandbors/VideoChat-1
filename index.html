<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∏–¥–µ–æ—á–∞—Ç</title>
  <style>
    body {
      margin: 0;
      background: black;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    /* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */
    #loginForm {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      z-index: 1000;
      min-width: 300px;
    }
    #loginForm.hidden { display: none; }

    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    input[type="text"] {
      width: 100%; padding: 12px;
      border: 2px solid #ddd; border-radius: 8px;
      font-size: 16px;
    }
    input[type="text"]:focus { border-color: #4CAF50; outline: none; }

    button {
      padding: 15px; width: 100%;
      background: #4CAF50; color: white;
      border: none; border-radius: 8px;
      cursor: pointer; font-size: 16px; font-weight: bold;
    }
    button:hover { background: #45a049; }

    /* –í–∏–¥–µ–æ */
    #remoteVideo {
      width: 100vw; height: 100vh;
      object-fit: cover;
      position: absolute; top: 0; left: 0;
      background: #000;
    }
    #localVideo {
      width: 160px; height: 110px;
      position: absolute; bottom: 15px; right: 15px;
      border-radius: 10px;
      border: 2px solid white;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
      background: #333;
    }
    .hidden { display: none !important; }

    /* –°—Ç–∞—Ç—É—Å */
    #status {
      position: absolute; top: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      padding: 8px 20px;
      border-radius: 20px;
      color: white;
      display: flex; align-items: center; gap: 10px;
      z-index: 100;
    }
    #statusDot {
      width: 12px; height: 12px; border-radius: 50%;
      background: gray;
    }

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #controls {
      position: absolute; bottom: 20px; left: 50%;
      transform: translateX(-50%);
      display: flex; gap: 12px; z-index: 100;
    }
    .control-btn {
      width: 50px; height: 50px;
      border-radius: 50%;
      border: none;
      font-size: 18px;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
    }
    .danger { background: #e74c3c; color: white; }
    .toggled { background: #f39c12; color: white; }

    /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–Ω–∞—Ç–µ */
    #roomInfo {
      position: absolute; top: 20px; right: 20px;
      background: rgba(0,0,0,0.6);
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      color: white;
      z-index: 100;
    }
    #copyRoomBtn, #shareRoomBtn {
      margin-top: 5px;
      font-size: 12px;
      background: #2196F3; color: white;
      padding: 5px 8px; border-radius: 6px;
      border: none; cursor: pointer;
    }
    #copyRoomBtn:hover, #shareRoomBtn:hover { background: #1976D2; }
  </style>
</head>
<body>
  <!-- –§–æ—Ä–º–∞ -->
  <div id="loginForm">
    <h2 style="text-align:center; margin-bottom:20px; color:#333;">–í—Ö–æ–¥ –≤ –≤–∏–¥–µ–æ—á–∞—Ç</h2>
    <div class="form-group">
      <label for="channelId">ScaleDrone Channel ID:</label>
      <input type="text" id="channelId" placeholder="–í–≤–µ–¥–∏—Ç–µ Channel ID">
    </div>
    <div class="form-group">
      <label for="roomName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã:</label>
      <input type="text" id="roomName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
    </div>
    <button onclick="initializeChat()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <!-- –í–∏–¥–µ–æ -->
  <video id="remoteVideo" autoplay playsinline class="hidden"></video>
  <video id="localVideo" autoplay muted playsinline class="hidden"></video>

  <!-- –°—Ç–∞—Ç—É—Å -->
  <div id="status" class="hidden">
    <div id="statusDot"></div>
    <div id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å -->
  <div id="controls" class="hidden">
    <button class="control-btn" id="startButton" onclick="startCall()">üìû</button>
    <button class="control-btn danger" id="endButton" onclick="endCall()">‚ùå</button>
    <button class="control-btn" id="micButton" onclick="toggleMic()">üé§</button>
    <button class="control-btn" id="camButton" onclick="toggleCam()">üì∑</button>
  </div>

  <!-- –ò–Ω—Ñ–æ -->
  <div id="roomInfo" class="hidden">
    <div>–ö–æ–º–Ω–∞—Ç–∞: <span id="currentRoomName"></span></div>
    <button id="copyRoomBtn" onclick="copyRoomName()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="shareRoomBtn" onclick="shareRoom()">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
  </div>

  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
  <script>
    let drone, room, localStream, peerConnection;
    let isCaller = false;
    let currentChannelId = '', currentRoomName = '';

    const config = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    };

    // UI —ç–ª–µ–º–µ–Ω—Ç—ã
    const loginForm = document.getElementById('loginForm');
    const statusEl = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    const remoteVideo = document.getElementById('remoteVideo');
    const localVideo = document.getElementById('localVideo');
    const controls = document.getElementById('controls');
    const roomInfo = document.getElementById('roomInfo');
    const currentRoomNameSpan = document.getElementById('currentRoomName');
    const micButton = document.getElementById('micButton');
    const camButton = document.getElementById('camButton');

    async function initializeChat() {
      currentChannelId = document.getElementById('channelId').value.trim();
      currentRoomName = document.getElementById('roomName').value.trim();

      if (!currentChannelId || !currentRoomName) {
        alert('–í–≤–µ–¥–∏—Ç–µ Channel ID –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã');
        return;
      }

      try {
        statusEl.classList.remove('hidden');
        statusText.textContent = '–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';

        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        localVideo.classList.remove('hidden');

        loginForm.classList.add('hidden');
        remoteVideo.classList.remove('hidden');
        controls.classList.remove('hidden');
        roomInfo.classList.remove('hidden');
        currentRoomNameSpan.textContent = currentRoomName;

        statusText.textContent = '–ù–∞–∂–º–∏—Ç–µ üìû —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫';
        statusDot.style.background = 'gray';
      } catch (err) {
        console.error(err);
        alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
      }
    }

    function copyRoomName() {
      navigator.clipboard.writeText(currentRoomName).then(() => {
        const btn = document.getElementById('copyRoomBtn');
        const original = btn.textContent;
        btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
        setTimeout(() => btn.textContent = original, 2000);
      });
    }

    function shareRoom() {
      const shareUrl = `${location.origin}${location.pathname}?room=${encodeURIComponent(currentRoomName)}`;
      navigator.clipboard.writeText(shareUrl).then(() => {
        const btn = document.getElementById('shareRoomBtn');
        const original = btn.textContent;
        btn.textContent = '‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞';
        setTimeout(() => btn.textContent = original, 2000);
      });
    }

    async function startCall() {
      statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
      statusDot.style.background = 'orange';

      drone = new ScaleDrone(currentChannelId);
      drone.on('open', err => {
        if (err) return alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ScaleDrone');
        room = drone.subscribe(currentRoomName);

        room.on('members', members => {
          if (members.length > 2) {
            statusText.textContent = '–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞';
            return;
          }
          isCaller = members.length === 1;
          if (!isCaller) startWebRTC();
        });

        room.on('member_join', member => {
          if (drone.clientId && member.id !== drone.clientId) {
            isCaller = true;
            startWebRTC();
          }
        });

        room.on('data', (msg, client) => {
          if (client.id !== drone.clientId) handleSignalingData(msg);
        });
      });
    }

    function startWebRTC() {
      peerConnection = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.onicecandidate = e => {
        if (e.candidate) drone.publish({ room: currentRoomName, message: { candidate: e.candidate } });
      };
      peerConnection.ontrack = e => {
        remoteVideo.srcObject = e.streams[0];
        statusText.textContent = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        statusDot.style.background = 'green';
      };

      if (isCaller) createOffer();
    }

    async function createOffer() {
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      drone.publish({ room: currentRoomName, message: { offer: peerConnection.localDescription } });
    }

    async function handleSignalingData(data) {
      if (data.offer) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        drone.publish({ room: currentRoomName, message: { answer: peerConnection.localDescription } });
      } else if (data.answer) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      } else if (data.candidate) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    }

    function endCall() {
      if (peerConnection) { peerConnection.close(); peerConnection = null; }
      if (drone) { drone.close(); drone = null; }
      remoteVideo.srcObject = null;
      statusText.textContent = '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω';
      statusDot.style.background = 'red';
    }

    function toggleMic() {
      const enabled = localStream.getAudioTracks()[0].enabled;
      localStream.getAudioTracks()[0].enabled = !enabled;
      micButton.classList.toggle('toggled', enabled);
    }

    function toggleCam() {
      const enabled = localStream.getVideoTracks()[0].enabled;
      localStream.getVideoTracks()[0].enabled = !enabled;
      camButton.classList.toggle('toggled', enabled);
    }

    window.addEventListener('beforeunload', endCall);

    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã –∏–∑ URL (?room=...)
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const roomParam = urlParams.get('room');
      if (roomParam) {
        document.getElementById('roomName').value = roomParam;
      }
    });
  </script>
</body>
</html>