// ===== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ =====
let drone = null, room = null, pc = null, localStream = null;
let currentChannelId = '', currentRoomName = '', roomKey = '';
let makingOffer = false, ignoreOffer = false, polite = false;

const statusEl   = document.getElementById('status');
const statusText = document.getElementById('statusText');
const statusDot  = document.getElementById('statusDot');
const loginForm  = document.getElementById('loginForm');
const remoteVideo = document.getElementById('remoteVideo');
const localVideo  = document.getElementById('localVideo');
const controls    = document.getElementById('controls');
const roomInfo    = document.getElementById('roomInfo');
const currentRoomNameSpan = document.getElementById('currentRoomName');

// STUN + –∑–∞–≥–æ—Ç–æ–≤–∫–∞ –ø–æ–¥ TURN
const configuration = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    // –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π TURN –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏:
    // {
    //   urls: [
    //     'turn:YOUR_TURN_HOST:3478?transport=udp',
    //     'turn:YOUR_TURN_HOST:3478?transport=tcp'
    //   ],
    //   username: 'turn_user',
    //   credential: 'turn_pass'
    // }
  ]
};

// ===== –£—Ç–∏–ª–∏—Ç—ã UI =====
function setStatus(text, color){
  statusText.textContent = text;
  statusDot.style.background = color || 'gray';
  statusEl.classList.remove('hidden');

  // –ü—Ä–æ–∫–∏–Ω–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É –±–µ–π–¥–∂–∞ –≤ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é (–¥–ª—è –æ—Ç—Å—Ç—É–ø–∞ –±–ª–æ–∫–∞ –ö–æ–º–Ω–∞—Ç—ã)
  requestAnimationFrame(() => {
    const h = statusEl.offsetHeight || 44;
    document.documentElement.style.setProperty('--status-h', h + 'px');
  });
}

function ensurePiPSize(){
  const w = localVideo.videoWidth || 0;
  const h = localVideo.videoHeight || 0;
  if (w < 2 || h < 2){
    // –∑–∞–¥–∞—ë–º —Ç–æ–ª—å–∫–æ —à–∏—Ä–∏–Ω—É ‚Äî –≤—ã—Å–æ—Ç–∞ –ø–æ—Å—á–∏—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ aspect-ratio
    localVideo.style.width = '160px';
    localVideo.style.height = '';
  }
}

// –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ PiP
function makeDraggable(el){
  let sx=0, sy=0, ex=0, ey=0, dragging=false;
  const clamp = (v,min,max)=>Math.min(Math.max(v,min), max);

  function onDown(e){
    dragging = true;
    const p = e.touches ? e.touches[0] : e;
    sx = p.clientX; sy = p.clientY;
    const r = el.getBoundingClientRect();
    ex = r.left; ey = r.top;
    el.style.transition = 'none';
    e.preventDefault();
  }
  function onMove(e){
    if (!dragging) return;
    const p = e.touches ? e.touches[0] : e;
    const dx = p.clientX - sx;
    const dy = p.clientY - sy;
    const vw = window.innerWidth, vh = window.innerHeight;
    const r = el.getBoundingClientRect();
    const nx = clamp(ex + dx, 4, vw - r.width - 4);
    const ny = clamp(ey + dy, 4, vh - r.height - 4);
    el.style.left = nx + 'px';
    el.style.top  = ny + 'px';
    el.style.right = 'auto';
    el.style.bottom = 'auto';
  }
  function onUp(){ dragging=false; el.style.transition=''; }

  el.addEventListener('mousedown', onDown);
  el.addEventListener('touchstart', onDown, {passive:false});
  window.addEventListener('mousemove', onMove, {passive:false});
  window.addEventListener('touchmove', onMove, {passive:false});
  window.addEventListener('mouseup', onUp);
  window.addEventListener('touchend', onUp);
}

// ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Ñ–æ—Ä–º–∞) =====
async function initializeChat(){
  currentChannelId = document.getElementById('channelId').value.trim();
  currentRoomName = document.getElementById('roomName').value.trim();

  if (!currentChannelId || !currentRoomName) {
    alert('–í–≤–µ–¥–∏—Ç–µ Channel ID –∏ –∫–æ–º–Ω–∞—Ç—É');
    return;
  }

  roomKey = 'observable-' + currentRoomName;

  statusEl.classList.remove('hidden');
  controls.classList.remove('hidden');
  roomInfo.classList.remove('hidden');
  remoteVideo.classList.remove('hidden');

  currentRoomNameSpan.textContent = currentRoomName;
  setStatus('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'gray');

  try{
    localVideo.muted = true;
    localVideo.playsInline = true;

    // –†–∞–Ω–Ω–∏–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∞–≤ (—Ä–µ–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∏–º –≤–∫–ª—é—á–∏–º –≤ startWebRTC)
    const testStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    testStream.getTracks().forEach(t => t.stop());

    loginForm.classList.add('hidden');
    setStatus('–ù–∞–∂–º–∏—Ç–µ üìû —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫', 'gray');
  }catch(err){
    console.error(err);
    alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
    setStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º', 'red');
  }
}

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —à–∞—Ä–∏–Ω–≥
function copyRoomName(){
  navigator.clipboard.writeText(currentRoomName).then(()=>{
    const btn = document.getElementById('copyRoomBtn');
    const t = btn.textContent;
    btn.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
    setTimeout(()=> btn.textContent = t, 2000);
  });
}

async function shareRoom(){
  const shareUrl = `${location.origin || ''}${location.pathname}?room=${encodeURIComponent(currentRoomName)}`;
  if (navigator.share) {
    try { await navigator.share({ title: '–í–∏–¥–µ–æ—á–∞—Ç', url: shareUrl }); return; }
    catch(e){ /* fallback –Ω–∏–∂–µ */ }
  }
  await navigator.clipboard.writeText(shareUrl);
  const btn = document.getElementById('shareRoomBtn');
  const t = btn.textContent;
  btn.textContent = '‚úì –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞';
  setTimeout(()=> btn.textContent = t, 2000);
}

// ===== –ó–≤–æ–Ω–æ–∫: ScaleDrone + WebRTC =====
function startCall(){
  setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'orange');

  drone = new ScaleDrone(currentChannelId);

  drone.on('open', error => {
    if (error) { console.error(error); setStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ScaleDrone', 'red'); return; }

    room = drone.subscribe(roomKey);

    room.on('open', e => { if (e) console.error(e); });

    // –ö–æ–≥–¥–∞ –ø–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å
    room.on('members', members => {
      // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 2-—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
      if (members.length > 2) {
        setStatus('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞ (–º–∞–∫—Å. 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞)', 'red');
        return;
      }
      // –≤—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ ‚Äî offerer; –ø–µ—Ä–≤—ã–π ‚Äî answerer (polite)
      const isOfferer = members.length === 2;
      startWebRTC(isOfferer);
    });
  });
}

function publishSignal(message){
  if (!drone) return;
  drone.publish({ room: roomKey, message });
}

async function startWebRTC(isOfferer){
  pc = new RTCPeerConnection(configuration);
  polite = !isOfferer; // –≤—Ç–æ—Ä–æ–π –∑–∞—à—ë–ª ‚Üí ¬´–≤–µ–∂–ª–∏–≤—ã–π¬ª

  // –õ–æ–∫–∞–ª—å–Ω—ã–µ –º–µ–¥–∏–∞
  try{
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { width: {ideal:1280}, height:{ideal:720}, facingMode:'user' },
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }catch(err){
    console.error('getUserMedia error:', err);
    alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
    setStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º', 'red');
    return;
  }

  // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã ‚Üí —á–µ—Ä–µ–∑ ScaleDrone
  pc.onicecandidate = e => { if (e.candidate) publishSignal({ candidate: e.candidate }); };

  // –°—Ç–∞—Ç—É—Å—ã ICE
  pc.oniceconnectionstatechange = () => {
    const st = pc.iceConnectionState;
    console.log('ICE state:', st);
    if (st === 'connected') setStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'green');
    else if (st === 'disconnected' || st === 'failed') setStatus('–ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏‚Ä¶', 'orange');
    else if (st === 'closed') setStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω', 'red');
  };

  // –£–¥–∞–ª—ë–Ω–Ω—ã–π —Ç—Ä–µ–∫
  pc.ontrack = e => {
    const stream = e.streams[0];
    if (!remoteVideo.srcObject || remoteVideo.srcObject.id !== stream.id) {
      remoteVideo.srcObject = stream;
      remoteVideo.classList.remove('hidden');
    }
  };

  // Perfect negotiation ‚Äî –æ—Ñ—Ñ–µ—Ä —Å–æ–∑–¥–∞—ë—Ç –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
  pc.onnegotiationneeded = async () => {
    try{
      makingOffer = true;
      await pc.setLocalDescription(await pc.createOffer());
      publishSignal({ sdp: pc.localDescription });
    }catch(e){
      console.error('negotiation error:', e);
    }finally{
      makingOffer = false;
    }
  };

  // –°–∏–≥–Ω–∞–ª–∏–Ω–≥ –æ—Ç ScaleDrone
  room.on('data', async (message, client) => {
    if (client.id === drone.clientId) return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏

    try{
      if (message.sdp) {
        const desc = message.sdp;
        const offerCollision = (desc.type === 'offer') &&
          (makingOffer || pc.signalingState !== 'stable');

        ignoreOffer = !polite && offerCollision;
        if (ignoreOffer) {
          console.log('Ignoring offer (not polite, collision).');
          return;
        }

        await pc.setRemoteDescription(desc);
        if (desc.type === 'offer') {
          await pc.setLocalDescription(await pc.createAnswer());
          publishSignal({ sdp: pc.localDescription });
        }
      } else if (message.candidate) {
        try { await pc.addIceCandidate(message.candidate); }
        catch (err) { if (!ignoreOffer) throw err; }
      }
    }catch(err){
      console.error('Signal handling error:', err);
    }
  });

  // –ü–æ–∫–∞–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ PiP
  localVideo.onloadedmetadata = () => {
    localVideo.play().catch(()=>{});
    ensurePiPSize();
    localVideo.classList.remove('hidden');
    makeDraggable(localVideo);
  };

  setStatus(isOfferer ? '–ò–¥—ë—Ç –∏–Ω–∏—Ü–∏–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞‚Ä¶' : '–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ñ—Ñ–µ—Ä–∞‚Ä¶', 'gray');
}

// –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ, mute/cam
function endCall(){
  try { if (pc) pc.close(); } catch {}
  pc = null;

  if (drone) { try { drone.close(); } catch {} drone = null; }
  room = null;

  if (remoteVideo.srcObject) {
    try { remoteVideo.srcObject.getTracks().forEach(t => t.stop()); } catch {}
    remoteVideo.srcObject = null;
  }
  if (localStream) {
    try { localStream.getTracks().forEach(t => t.stop()); } catch {}
    localStream = null;
  }

  document.getElementById('micButton')?.classList.remove('toggled');
  document.getElementById('camButton')?.classList.remove('toggled');

  setStatus('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω', 'red');
}

function toggleMic(){
  const t = localStream?.getAudioTracks?.()[0];
  if (!t) return;
  t.enabled = !t.enabled;
  const muted = !t.enabled;
  const btn = document.getElementById('micButton');
  btn.classList.toggle('toggled', muted);
  btn.title = muted ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω';
}

function toggleCam(){
  const t = localStream?.getVideoTracks?.()[0];
  if (!t) return;
  t.enabled = !t.enabled;
  const off = !t.enabled;
  const btn = document.getElementById('camButton');
  btn.classList.toggle('toggled', off);
  btn.title = off ? '–ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞' : '–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞';
}

window.addEventListener('beforeunload', endCall);

// –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ ?room=
window.addEventListener('DOMContentLoaded', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const roomParam = urlParams.get('room');
  if (roomParam) document.getElementById('roomName').value = roomParam;
});